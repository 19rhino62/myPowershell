############################################################################################################################################################
## *********************************************************************************************************************************************************
## 
## Title:
## Author: Wayne Morrison
## Purpose: Collect DC information for domains.
##
##.INPUT Scans all the DCs in local domain and uses that information to capture the following details:
## HostName IP	Site  OS Role FQDN
##
## Example:
##
##.OUTPUT
## 	HostName: ZTLVDC001
##	IP: 10.63.119.25
##	OS: Microsoft Windows Server 2016 Standard
##	FQDN: ZTLVDC001.corporate.healthcareit.net
##
## *********************************************************************************************************************************************************
############################################################################################################################################################

############################################################################################################################################################
## *********************************************************************************************************************************************************
##                                _____ _    _          _   _  _____ ______   _      ____   _____ 
##                               / ____| |  | |   /\   | \ | |/ ____|  ____| | |    / __ \ / ____|
##                              | |    | |__| |  /  \  |  \| | |  __| |__    | |   | |  | | |  __ 
##                              | |    |  __  | / /\ \ | . ` | | |_ |  __|   | |   | |  | | | |_ |
##                              | |____| |  | |/ ____ \| |\  | |__| | |____  | |___| |__| | |__| |
##                               \_____|_|  |_/_/    \_\_| \_|\_____|______| |______\____/ \_____|
##
##----------------------------------------------------------------------------------------------------------------------------------------------------------
## Date     | Description of change                                                                                                    | Author 
##----------------------------------------------------------------------------------------------------------------------------------------------------------
##
## 09/03/20   Created the script.                                                                                                        Wayne Morrison
## mm/dd/yy   Removed dependency on PSexec and replaced with WMIC to allow faster processing.                                            Author
## mm/dd/yy   Added a wait command to insure the registry values have time to update before pulling them.                                Author
##
## *********************************************************************************************************************************************************
############################################################################################################################################################

  # ==============================================================================================================================================
  # Clear the screen
  # ==============================================================================================================================================
#    CLS

############################################################################################################################################################
## *********************************************************************************************************************************************************
##                               __  __          _____ _   _    _____  _____ _____  _____ _____ _______ 
##                              |  \/  |   /\   |_   _| \ | |  / ____|/ ____|  __ \|_   _|  __ \__   __|
##                              | \  / |  /  \    | | |  \| | | (___ | |    | |__) | | | | |__) | | |   
##                              | |\/| | / /\ \   | | | . ` |  \___ \| |    |  _  /  | | |  ___/  | |   
##                              | |  | |/ ____ \ _| |_| |\  |  ____) | |____| | \ \ _| |_| |      | |   
##                              |_|  |_/_/    \_\_____|_| \_| |_____/ \_____|_|  \_\_____|_|      |_| 
##
## *********************************************************************************************************************************************************
############################################################################################################################################################

$UserPath = $env:USERPROFILE
$DocumentPath = "$UserPath\Documents\"
CD $DocumentPath

$DCArray = @()

#####################################Get ALL DC Servers################################# 
$getForest = [system.directoryservices.activedirectory.Forest]::GetCurrentForest()
$DCServers = $getForest.domains | ForEach-Object {$_.DomainControllers} | ForEach-Object {$_.Name}  

#Added domain name for report header 5/22/2020 wjm
$Domain = $getForest.Name
 
################Ping Test###### 
 
foreach ($DC in $DCServers){ 

    $Ping = Test-Connection -ComputerName $DC -Count 1 -ErrorAction SilentlyContinue

    If ($Ping) {
        $WMIOS = Get-WmiObject -ComputerName $DC -ClassName Win32_OperatingSystem -ErrorAction SilentlyContinue
        $DCInfo = New-Object PSObject

  # ==============================================================================================================================================
  # HOSTNAME
  # ==============================================================================================================================================
        $pos = $dc.IndexOf(".")
        $hostname = $dc.Substring(0, $pos)

        $DCInfo | Add-Member -Type NoteProperty -Name "Hostname" -Value $hostname -Force

        Write-Host "`n`tSuccessful Connection" -ForegroundColor Green
        Write-Host "`tHostName: " -NoNewline -ForegroundColor Green
        Write-Host $hostname

  # ==============================================================================================================================================
  # ## IP
  # ==============================================================================================================================================
        $DCInfo | Add-Member -Type NoteProperty -Name "IP Address" -Value $Ping.IPV4Address -Force

        Write-Host "`tIP: " -NoNewline -ForegroundColor Green
        Write-Host $Ping.IPV4Address
	
  # ==============================================================================================================================================
  # ## Site	
  # ==============================================================================================================================================

  # ==============================================================================================================================================
  # ## OS
  # ==============================================================================================================================================
        $DCInfo | Add-Member -Type NoteProperty -Name "OS" -Value $WMIOS.Caption -Force

        Write-Host "`tOS: " -NoNewline -ForegroundColor Green
        Write-Host $WMIOS.Caption

  # ==============================================================================================================================================
  # DC ROLE
  # ==============================================================================================================================================

  # ==============================================================================================================================================
  # ## FQDN
  # ==============================================================================================================================================

        $DCInfo | Add-Member -Type NoteProperty -Name "FQDN" -Value $DC -Force

        Write-Host "`tFQDN: " -NoNewline -ForegroundColor Green
        Write-Host $DC
    }

Else {
    $DCInfo | Add-Member -Type NoteProperty -Name "Hostname" -Value "NA" -Force
    $DCInfo | Add-Member -Type NoteProperty -Name "IP Address" -Value "NA" -Force
    $DCInfo | Add-Member -Type NoteProperty -Name "OS" -Value "NA" -Force
    $DCInfo | Add-Member -Type NoteProperty -Name "FQDN" -Value $DC -Force

    Write-Host "`n`tConnection failed!" -ForegroundColor Red
    Write-Host "`ton Host:" -NoNewline -ForegroundColor Red
    Write-Host $DC
    }

$DCArray += $DCInfo
}

$DCArray | Export-Csv .\$Domain-$((Get-Date).ToString("yyyyMMdd_HHmmss")).csv

Write-Host "`nLogFile: .\$Domain-$((Get-Date).ToString("yyyyMMdd_HHmmss")).csv" -ForegroundColor DarkYellow